"use client";
import LanguageSwitcher from "@/components/LanguageSwitcher";
import ProtectedRoute from "@/components/ProtectedRoute";
import ThemeToggle from "@/components/ThemeToggle";
import { useTranslations } from "@/hooks/useTranslations";
import { API_URL } from '@/lib/api';
import { useEffect, useMemo, useState } from "react";
import { FaBan, FaBars, FaBox, FaBuilding, FaBullhorn, FaChartBar, FaCheckCircle, FaCheckSquare, FaChevronLeft, FaChevronRight, FaClock, FaCreditCard, FaCrown, FaDollarSign, FaDownload, FaEdit, FaEye, FaPlus, FaSearch, FaServer, FaSignOutAlt, FaSquare, FaStar, FaSync, FaTag, FaTicketAlt, FaTimes, FaTimesCircle, FaTrash, FaUndo, FaUserSecret, FaUserShield, FaUsers } from "react-icons/fa";

const API = `${API_URL}/api/v1/admin/admin`;

export default function Page() {
  const { t } = useTranslations();
  const [data, setData] = useState({});
  const [adminInfo, setAdminInfo] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [activeTab, setActiveTab] = useState("dashboard");
  const [toast, setToast] = useState(null);
  const [search, setSearch] = useState("");
  const [page, setPage] = useState(1);
  const [editingUser, setEditingUser] = useState(null);
  const [editForm, setEditForm] = useState({});
  const [editingBusiness, setEditingBusiness] = useState(null);
  const [businessForm, setBusinessForm] = useState({});
  const [viewBusiness, setViewBusiness] = useState(null);
  const [deleteConfirm, setDeleteConfirm] = useState(null);
  const [showCreateAdmin, setShowCreateAdmin] = useState(false);
  const [newAdmin, setNewAdmin] = useState({ name: "", email: "", password: "" });
  const [showAnnouncement, setShowAnnouncement] = useState(false);
  const [announcement, setAnnouncement] = useState({ title: "", message: "", targetAudience: "all" });
  const [filter, setFilter] = useState("all");
  const [submitting, setSubmitting] = useState(false);
  const [selected, setSelected] = useState([]);
  const perPage = 9;

  const showToast = (m, t = "success") => { setToast({ message: m, type: t }); setTimeout(() => setToast(null), 3000); };
  const api = async (url, opts = {}) => fetch(url, { credentials: "include", ...opts, headers: { "Content-Type": "application/json", ...opts.headers } });

  const refresh = async () => {
    setLoading(true);
    try {
      const eps = ["users", "dashboard", "businesses", "tickets", "reviews", "categories", "payments", "staff", "subscriptions", "queue-monitoring", "system-health"];
      const res = await Promise.all(eps.map(e => api(`${API}/${e}`).then(r => r.ok ? r.json() : null).catch(() => null)));
      setData({ users: res[0], dashboard: res[1], businesses: res[2], tickets: res[3], reviews: res[4], categories: res[5], payments: res[6], staff: res[7], subscriptions: res[8], queues: res[9], health: res[10] });
      showToast(t('adminDashboard.common.refresh'));
    } catch (e) { showToast(t('toast.failed'), "error"); }
    setLoading(false);
  };

  useEffect(() => { refresh(); api(`${API_URL}/api/v1/auth/me`).then(r => r.ok ? r.json() : null).then(d => setAdminInfo(d?.data || d?.user)); }, []);

  const d = data.dashboard?.data || {};
  const users = useMemo(() => (data.users?.users || []).filter(u => u && u.role === "user"), [data]);
  const admins = useMemo(() => (data.users?.users || []).filter(u => u && u.role === "admin"), [data]);
  const owners = useMemo(() => (data.users?.users || []).filter(u => u && u.role === "owner"), [data]);
  const staff = useMemo(() => (data.staff?.staff || []).filter(s => s), [data]);
  const businesses = useMemo(() => (data.businesses?.businesses || []).filter(b => b), [data]);
  const tickets = useMemo(() => (data.tickets?.tickets || []).filter(t => t), [data]);
  const reviews = useMemo(() => (data.reviews?.reviews || []).filter(r => r), [data]);
  const categories = useMemo(() => (data.categories?.categories || []).filter(c => c), [data]);
  const payments = useMemo(() => (data.payments?.payments || []).filter(p => p), [data]);
  const subs = useMemo(() => (data.subscriptions?.subscriptions || []).filter(s => s), [data]);
  const subStats = data.subscriptions?.stats || {};
  const queues = useMemo(() => (data.queues?.queues || []).filter(q => q), [data]);
  const health = data.health?.health || {};

  const filterFn = (items, fields) => items.filter(i => i && fields.some(f => i[f]?.toString().toLowerCase().includes(search.toLowerCase())));
  const paginate = (items) => items.slice((page - 1) * perPage, page * perPage);
  const totalPages = (items) => Math.ceil(items.length / perPage);
  const statusColor = (s) => ({ waiting: "bg-amber-500/10 text-amber-600", completed: "bg-emerald-500/10 text-emerald-600", cancelled: "bg-red-500/10 text-red-600", active: "bg-emerald-500/10 text-emerald-600", inactive: "bg-gray-500/10 text-gray-600" }[s] || "bg-gray-500/10 text-gray-600");

  const deleteUser = async (id) => { if (!id) return; setSubmitting(true); const r = await api(`${API}/users/${id}`, { method: "DELETE" }); if (r.ok) { showToast(t('toast.deleted')); refresh(); } else showToast(t('toast.failed'), "error"); setSubmitting(false); setDeleteConfirm(null); };
  const banUser = async (id, ban) => { if (!id) return; await api(`${API}/users/${id}/${ban ? "unban" : "ban"}`, { method: "PATCH", body: JSON.stringify({}) }); showToast(ban ? t('toast.unbanned') : t('toast.banned')); refresh(); };
  const updateUser = async () => { if (!editingUser?._id) return; setSubmitting(true); const r = await api(`${API}/users/${editingUser._id}`, { method: "PUT", body: JSON.stringify(editForm) }); if (r.ok) { showToast(t('toast.updated')); refresh(); setEditingUser(null); } else showToast(t('toast.failed'), "error"); setSubmitting(false); };
  const updateBusiness = async () => { if (!editingBusiness?._id) return; setSubmitting(true); const r = await api(`${API_URL}/api/v1/businesses/business/${editingBusiness._id}`, { method: "PUT", body: JSON.stringify(businessForm) }); if (r.ok) { showToast(t('toast.updated')); refresh(); setEditingBusiness(null); } else showToast(t('toast.failed'), "error"); setSubmitting(false); };
  const deleteBusiness = async (id) => { if (!id) return; setSubmitting(true); const r = await api(`${API_URL}/api/v1/businesses/business/${id}`, { method: "DELETE" }); if (r.ok) { showToast(t('toast.deleted')); refresh(); } else showToast(t('toast.failed'), "error"); setSubmitting(false); setDeleteConfirm(null); };
  const toggleStatus = async (b) => { if (!b?._id) return; await api(`${API_URL}/api/v1/businesses/business/${b._id}`, { method: "PUT", body: JSON.stringify({ status: b.status === "active" ? "inactive" : "active" }) }); showToast(t('toast.updated')); refresh(); };
  const deleteReview = async (id) => { if (!id) return; setSubmitting(true); await api(`${API}/reviews/${id}`, { method: "DELETE" }); showToast(t('toast.deleted')); refresh(); setSubmitting(false); setDeleteConfirm(null); };
  const createAdmin = async () => { if (!newAdmin.name || !newAdmin.email || !newAdmin.password) { showToast(t('adminDashboard.common.fillFields'), "error"); return; } setSubmitting(true); const r = await api(`${API}/create-admin`, { method: "POST", body: JSON.stringify(newAdmin) }); if (r.ok) { showToast(t('toast.created')); setShowCreateAdmin(false); setNewAdmin({ name: "", email: "", password: "" }); refresh(); } else { const e = await r.json(); showToast(e.message || t('toast.failed'), "error"); } setSubmitting(false); };
  const sendAnnouncement = async () => { if (!announcement.title || !announcement.message) { showToast(t('adminDashboard.common.fillFields'), "error"); return; } setSubmitting(true); const r = await api(`${API}/announcements`, { method: "POST", body: JSON.stringify(announcement) }); if (r.ok) { const d = await r.json(); showToast(d.message); setShowAnnouncement(false); setAnnouncement({ title: "", message: "", targetAudience: "all" }); } else showToast(t('toast.failed'), "error"); setSubmitting(false); };
  const bulkAction = async (action, type) => { if (selected.length === 0) { showToast(t('adminDashboard.common.selectItems'), "error"); return; } setSubmitting(true); const r = await api(`${API}/bulk-action`, { method: "POST", body: JSON.stringify({ action, type, ids: selected }) }); if (r.ok) { const d = await r.json(); showToast(d.message); setSelected([]); refresh(); } else showToast(t('toast.failed'), "error"); setSubmitting(false); };
  const exportData = (type) => { window.open(`${API}/export/${type}`, "_blank"); };
  const toggleSelect = (id) => { if (!id) return; setSelected(s => s.includes(id) ? s.filter(x => x !== id) : [...s, id]); };
  const selectAll = (items) => setSelected(s => s.length === items.length ? [] : items.filter(i => i?._id).map(i => i._id));

  const tabs = [{ id: "dashboard", label: t('adminDashboard.tabs.overview'), icon: FaChartBar }, { id: "users", label: t('adminDashboard.tabs.users'), icon: FaUsers }, { id: "businesses", label: t('adminDashboard.tabs.businesses'), icon: FaBuilding }, { id: "tickets", label: t('adminDashboard.tabs.tickets'), icon: FaTicketAlt }, { id: "reviews", label: t('adminDashboard.tabs.reviews'), icon: FaStar }, { id: "payments", label: t('adminDashboard.tabs.payments'), icon: FaCreditCard }, { id: "subscriptions", label: t('adminDashboard.tabs.subscriptions'), icon: FaBox }, { id: "categories", label: t('adminDashboard.tabs.categories'), icon: FaTag }, { id: "queues", label: t('adminDashboard.tabs.queueMonitor'), icon: FaClock }, { id: "admins", label: t('adminDashboard.tabs.admins'), icon: FaUserSecret }, { id: "health", label: t('adminDashboard.tabs.systemHealth'), icon: FaServer }];

  if (loading) return <div className="min-h-screen bg-gray-50 dark:bg-gray-950 flex items-center justify-center"><div className="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin" /></div>;
  if (error) return <div className="min-h-screen bg-gray-50 dark:bg-gray-950 flex items-center justify-center"><div className="card-enterprise p-8 text-center"><FaTimesCircle className="text-red-500 text-4xl mx-auto mb-4" /><p>{error}</p><button onClick={refresh} className="btn-primary mt-4">{t('adminDashboard.common.retry')}</button></div></div>;

  return (
    <ProtectedRoute allowedRoles={["admin"]}>
      <div className="min-h-screen bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-white">
        <div className="lg:hidden fixed top-0 left-0 right-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 p-4 flex justify-between items-center z-50"><button onClick={() => setSidebarOpen(true)}><FaBars /></button><span className="font-bold gradient-text">{t('adminDashboard.sidebar.adminRole')}</span><div className="w-8 h-8 rounded-lg bg-emerald-500 flex items-center justify-center text-white font-bold text-sm">{adminInfo?.name?.charAt(0) || "A"}</div></div>
        <div className="flex">
          {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 lg:hidden" onClick={() => setSidebarOpen(false)} />}
          <aside className={`fixed lg:sticky top-0 left-0 z-50 h-screen bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 transition-all ${sidebarOpen ? "translate-x-0" : "-translate-x-full lg:translate-x-0"} ${sidebarCollapsed ? "w-16" : "w-56"}`}>
            <div className="flex flex-col h-full">
              <div className="p-3 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between">{!sidebarCollapsed && <div className="flex items-center gap-2"><FaCrown className="text-emerald-500" /><span className="font-bold text-sm">{t('adminDashboard.title')}</span></div>}<button onClick={() => setSidebarCollapsed(!sidebarCollapsed)} className="hidden lg:block"><FaChevronLeft className={sidebarCollapsed ? "rotate-180" : ""} /></button><button onClick={() => setSidebarOpen(false)} className="lg:hidden"><FaTimes /></button></div>
              <nav className="flex-1 p-2 overflow-y-auto space-y-1">{tabs.map(tab => <button key={tab.id} onClick={() => { setActiveTab(tab.id); setSidebarOpen(false); setSearch(""); setPage(1); setSelected([]); }} className={`w-full flex items-center gap-2 px-3 py-2 rounded text-sm ${activeTab === tab.id ? "bg-emerald-500/10 text-emerald-600 font-medium" : "text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800"}`}><tab.icon />{!sidebarCollapsed && tab.label}</button>)}</nav>
              {!sidebarCollapsed && <div className="p-2 border-t border-gray-200 dark:border-gray-800 space-y-2"><div className="flex justify-between text-xs"><span className="text-gray-500">{t('adminDashboard.sidebar.theme')}</span><ThemeToggle /></div><div className="flex justify-between text-xs"><span className="text-gray-500">{t('adminDashboard.sidebar.lang')}</span><LanguageSwitcher /></div></div>}
              <div className="p-2 border-t border-gray-200 dark:border-gray-800"><div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 rounded-lg bg-emerald-500 flex items-center justify-center text-white font-bold text-sm">{adminInfo?.name?.charAt(0) || "A"}</div>{!sidebarCollapsed && <div className="text-xs"><p className="font-medium truncate">{adminInfo?.name}</p><p className="text-gray-500 truncate">{adminInfo?.email}</p></div>}</div>{!sidebarCollapsed && <button onClick={() => { localStorage.removeItem('accessToken'); document.cookie = 'accessToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;'; document.cookie = 'refreshToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;'; api(`${API_URL}/api/v1/auth/logout`, { method: "POST" }); window.location.href = "/admin/login"; }} className="w-full px-3 py-1.5 rounded bg-red-500/10 text-red-600 text-sm flex items-center justify-center gap-2"><FaSignOutAlt /> {t('adminDashboard.sidebar.logout')}</button>}</div>
            </div>
          </aside>
          <main className="flex-1 min-h-screen pt-14 lg:pt-0 p-4">
            <div className="flex flex-wrap gap-3 justify-between items-center mb-6"><div><h1 className="text-xl font-bold">{tabs.find(tab => tab.id === activeTab)?.label}</h1><p className="text-gray-500 text-sm">{new Date().toLocaleDateString()}</p></div><div className="flex gap-2"><button onClick={() => setShowAnnouncement(true)} className="px-3 py-2 rounded bg-indigo-500/10 text-indigo-600 text-sm flex items-center gap-2"><FaBullhorn /> {t('adminDashboard.announcement.button')}</button><button onClick={refresh} className="px-3 py-2 rounded bg-emerald-500/10 text-emerald-600 text-sm flex items-center gap-2"><FaSync className={loading ? "animate-spin" : ""} /> {t('adminDashboard.common.refresh')}</button></div></div>

            {activeTab === "dashboard" && <div className="space-y-4"><div className="grid grid-cols-2 md:grid-cols-4 gap-3">{[{ l: t('adminDashboard.overview.totalUsers'), v: d.userCount || users.length, c: "emerald", i: FaUsers }, { l: t('adminDashboard.overview.totalBusinesses'), v: d.businessCount || businesses.length, c: "teal", i: FaBuilding }, { l: t('adminDashboard.overview.totalTickets'), v: d.ticketStats?.total || tickets.length, c: "indigo", i: FaTicketAlt }, { l: t('adminDashboard.overview.totalRevenue'), v: "$" + (d.totalRevenue || 0), c: "amber", i: FaDollarSign }].map((s, i) => <div key={i} className="card-enterprise p-4"><div className="flex items-center gap-2 mb-2"><div className={`w-8 h-8 rounded bg-${s.c}-500/10 flex items-center justify-center`}><s.i className={`text-${s.c}-500`} /></div></div><p className="text-2xl font-bold">{s.v}</p><p className="text-xs text-gray-500">{s.l}</p></div>)}</div><div className="grid grid-cols-2 md:grid-cols-4 gap-3">{[{ l: t('adminDashboard.overview.todayUsers'), v: d.todayStats?.users || 0 }, { l: t('adminDashboard.overview.todayBiz'), v: d.todayStats?.businesses || 0 }, { l: t('adminDashboard.overview.todayTickets'), v: d.todayStats?.tickets || 0 }, { l: t('adminDashboard.overview.completed'), v: d.ticketStats?.completed || 0 }].map((s, i) => <div key={i} className="card-enterprise p-3 text-center"><p className="text-xl font-bold">{s.v}</p><p className="text-xs text-gray-500">{s.l}</p></div>)}</div></div>}

            {activeTab === "users" && <div className="space-y-4"><div className="flex flex-wrap gap-2 justify-between"><div className="flex gap-2"><div className="relative"><FaSearch className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" /><input placeholder={t('adminDashboard.users.searchPlaceholder')} value={search} onChange={e => { setSearch(e.target.value); setPage(1); }} className="input-enterprise pl-10 text-sm w-40" /></div><button onClick={() => exportData("users")} className="px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 text-sm flex items-center gap-2"><FaDownload /> {t('adminDashboard.users.export')}</button></div>{selected.length > 0 && <div className="flex gap-2"><button onClick={() => bulkAction("ban", "users")} className="px-3 py-1 rounded bg-amber-500/10 text-amber-600 text-xs">{t('adminDashboard.users.ban')} ({selected.length})</button><button onClick={() => bulkAction("delete", "users")} className="px-3 py-1 rounded bg-red-500/10 text-red-600 text-xs">{t('adminDashboard.users.delete')} ({selected.length})</button></div>}</div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">{paginate(filterFn(users, ["name", "email"])).map(u => <div key={u._id} className={`card-enterprise p-3 ${u.isBanned ? "border-red-300 dark:border-red-800" : ""}`}><div className="flex items-center gap-2 mb-2"><button onClick={() => toggleSelect(u._id)}>{selected.includes(u._id) ? <FaCheckSquare className="text-emerald-500" /> : <FaSquare className="text-gray-400" />}</button><div className={`w-8 h-8 rounded flex items-center justify-center text-white font-bold text-sm ${u.isBanned ? "bg-red-500" : "bg-emerald-500"}`}>{u.name?.charAt(0)}</div><div><p className="font-medium text-sm">{u.name} {u.isBanned && <span className="text-red-500 text-xs">({t('adminDashboard.users.banned')})</span>}</p><p className="text-xs text-gray-500">{u.email}</p></div></div><div className="flex gap-1"><button onClick={() => { setEditingUser(u); setEditForm({ name: u.name, email: u.email, phone: u.phone || "" }); }} className="px-2 py-1 rounded bg-indigo-500/10 text-indigo-600 text-xs"><FaEdit /></button><button onClick={() => banUser(u._id, u.isBanned)} className={`px-2 py-1 rounded text-xs ${u.isBanned ? "bg-emerald-500/10 text-emerald-600" : "bg-amber-500/10 text-amber-600"}`}>{u.isBanned ? <FaUndo /> : <FaBan />}</button><button onClick={() => setDeleteConfirm({ t: "user", id: u._id, n: u.name })} className="px-2 py-1 rounded bg-red-500/10 text-red-600 text-xs"><FaTrash /></button></div></div>)}</div>{totalPages(filterFn(users, ["name", "email"])) > 1 && <div className="flex justify-center gap-2"><button onClick={() => setPage(p => Math.max(1, p - 1))} disabled={page === 1} className="px-3 py-1 bg-gray-100 dark:bg-gray-800 rounded disabled:opacity-50"><FaChevronLeft /></button><span>{page}/{totalPages(filterFn(users, ["name", "email"]))}</span><button onClick={() => setPage(p => p + 1)} disabled={page >= totalPages(filterFn(users, ["name", "email"]))} className="px-3 py-1 bg-gray-100 dark:bg-gray-800 rounded disabled:opacity-50"><FaChevronRight /></button></div>}</div>}

            {activeTab === "businesses" && <div className="space-y-4"><div className="flex gap-2"><div className="relative"><FaSearch className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" /><input placeholder={t('adminDashboard.businesses.searchPlaceholder')} value={search} onChange={e => setSearch(e.target.value)} className="input-enterprise pl-10 text-sm w-40" /></div><button onClick={() => exportData("businesses")} className="px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 text-sm flex items-center gap-2"><FaDownload /> {t('adminDashboard.users.export')}</button></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">{paginate(filterFn(businesses, ["name"])).map(b => <div key={b._id} className="card-enterprise p-3"><div className="flex justify-between mb-2"><div className="flex items-center gap-2"><div className="w-8 h-8 rounded bg-teal-500 flex items-center justify-center text-white font-bold text-sm">{b.name?.charAt(0)}</div><div><p className="font-medium text-sm">{b.name}</p><p className="text-xs text-gray-500">{b.specialization}</p></div></div><button onClick={() => toggleStatus(b)} className={`px-2 py-1 rounded-full text-xs ${statusColor(b.status)}`}>{t(`adminDashboard.statuses.${b.status}`)}</button></div><div className="flex gap-1"><button onClick={() => setViewBusiness(b)} className="px-2 py-1 rounded bg-gray-500/10 text-gray-600 text-xs"><FaEye /></button><button onClick={() => { setEditingBusiness(b); setBusinessForm({ name: b.name, email: b.email, status: b.status }); }} className="px-2 py-1 rounded bg-indigo-500/10 text-indigo-600 text-xs"><FaEdit /></button><button onClick={() => setDeleteConfirm({ t: "business", id: b._id, n: b.name })} className="px-2 py-1 rounded bg-red-500/10 text-red-600 text-xs"><FaTrash /></button></div></div>)}</div></div>}

            {activeTab === "tickets" && <div className="space-y-4"><div className="flex gap-2"><select value={filter} onChange={e => setFilter(e.target.value)} className="input-enterprise text-sm w-auto"><option value="all">{t('adminDashboard.tickets.filterAll')}</option><option value="waiting">{t('adminDashboard.tickets.filterWaiting')}</option><option value="completed">{t('adminDashboard.tickets.filterCompleted')}</option><option value="cancelled">{t('adminDashboard.tickets.filterCancelled')}</option></select><button onClick={() => exportData("tickets")} className="px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 text-sm flex items-center gap-2"><FaDownload /> {t('adminDashboard.users.export')}</button></div><div className="card-enterprise overflow-x-auto"><table className="w-full text-sm"><thead><tr className="border-b border-gray-200 dark:border-gray-800"><th className="text-start p-2">#</th><th className="text-start p-2">{t('adminDashboard.tickets.business')}</th><th className="text-start p-2">{t('adminDashboard.tickets.customer')}</th><th className="text-start p-2">{t('adminDashboard.users.status')}</th><th className="text-start p-2">{t('adminDashboard.tickets.date')}</th></tr></thead><tbody>{tickets.filter(tk => filter === "all" || tk.status === filter).slice(0, 50).map(tk => <tr key={tk._id} className="border-b border-gray-100 dark:border-gray-800"><td className="p-2 font-bold text-emerald-600">#{tk.ticketNumber}</td><td className="p-2">{tk.businessId?.name || "N/A"}</td><td className="p-2">{tk.userId?.name || tk.guestName || t('adminDashboard.tickets.guest')}</td><td className="p-2"><span className={`px-2 py-1 rounded-full text-xs ${statusColor(tk.status)}`}>{t(`adminDashboard.statuses.${tk.status}`)}</span></td><td className="p-2 text-gray-500">{new Date(tk.createdAt).toLocaleDateString()}</td></tr>)}</tbody></table></div></div>}

            {activeTab === "reviews" && <div className="space-y-4"><button onClick={() => exportData("reviews")} className="px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 text-sm flex items-center gap-2"><FaDownload /> {t('adminDashboard.users.export')}</button><div className="grid grid-cols-1 md:grid-cols-2 gap-3">{reviews.slice(0, 20).map(r => <div key={r._id} className="card-enterprise p-3"><div className="flex justify-between mb-2"><div><p className="font-medium text-sm">{r.userId?.name || t('adminDashboard.reviews.anonymous')}</p><p className="text-xs text-gray-500">{r.businessId?.name}</p></div><div className="flex text-amber-500">{[...Array(r.rating)].map((_, i) => <FaStar key={i} className="text-xs" />)}</div></div><p className="text-sm text-gray-600 dark:text-gray-400 mb-2">{r.comment}</p><div className="flex justify-between"><span className="text-xs text-gray-500">{new Date(r.createdAt).toLocaleDateString()}</span><button onClick={() => setDeleteConfirm({ t: "review", id: r._id, n: "review" })} className="px-2 py-1 rounded bg-red-500/10 text-red-600 text-xs"><FaTrash /></button></div></div>)}</div></div>}

            {activeTab === "payments" && <div className="card-enterprise overflow-x-auto"><table className="w-full text-sm"><thead><tr className="border-b border-gray-200 dark:border-gray-800"><th className="text-start p-2">#</th><th className="text-start p-2">{t('adminDashboard.payments.business')}</th><th className="text-start p-2">{t('adminDashboard.payments.amount')}</th><th className="text-start p-2">{t('adminDashboard.payments.method')}</th><th className="text-start p-2">{t('adminDashboard.payments.date')}</th></tr></thead><tbody>{payments.map(p => <tr key={p._id} className="border-b border-gray-100 dark:border-gray-800"><td className="p-2">#{p.ticketNumber}</td><td className="p-2">{p.businessId?.name}</td><td className="p-2 font-bold text-emerald-600">${p.price || 0}</td><td className="p-2">{p.paymentMethod}</td><td className="p-2 text-gray-500">{new Date(p.createdAt).toLocaleDateString()}</td></tr>)}</tbody></table></div>}

            {activeTab === "subscriptions" && <div className="space-y-4"><div className="grid grid-cols-4 gap-3">{[{ l: t('adminDashboard.subscriptions.stats.total'), v: subStats.total }, { l: t('adminDashboard.subscriptions.stats.active'), v: subStats.active, c: "emerald" }, { l: t('adminDashboard.subscriptions.stats.trial'), v: subStats.trial, c: "blue" }, { l: t('adminDashboard.subscriptions.stats.inactive'), v: subStats.inactive, c: "gray" }].map((s, i) => <div key={i} className="card-enterprise p-3 text-center"><p className={`text-xl font-bold ${s.c ? `text-${s.c}-600` : ""}`}>{s.v || 0}</p><p className="text-xs text-gray-500">{s.l}</p></div>)}</div><div className="card-enterprise overflow-x-auto"><table className="w-full text-sm"><thead><tr className="border-b border-gray-200 dark:border-gray-800"><th className="text-start p-2">{t('adminDashboard.subscriptions.business')}</th><th className="text-start p-2">{t('adminDashboard.subscriptions.plan')}</th><th className="text-start p-2">{t('adminDashboard.subscriptions.status')}</th></tr></thead><tbody>{subs.map(s => <tr key={s._id} className="border-b border-gray-100 dark:border-gray-800"><td className="p-2">{s.businessName}</td><td className="p-2 capitalize">{s.plan}</td><td className="p-2"><span className={`px-2 py-1 rounded-full text-xs ${statusColor(s.status)}`}>{t(`adminDashboard.statuses.${s.status}`)}</span></td></tr>)}</tbody></table></div></div>}

            {activeTab === "categories" && <div className="grid grid-cols-2 md:grid-cols-4 gap-3">{categories.map(c => <div key={c.name} className="card-enterprise p-4 flex justify-between items-center"><span>{c.name}</span><span className="px-3 py-1 rounded-full bg-emerald-500/10 text-emerald-600 font-bold">{c.count}</span></div>)}</div>}

            {activeTab === "queues" && <div className="space-y-4"><p className="text-gray-500 text-sm">{t('adminDashboard.queues.liveStatus')}</p><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">{queues.map(q => <div key={q._id} className="card-enterprise p-4"><div className="flex justify-between mb-2"><span className="font-medium">{q.businessName}</span><span className={`px-2 py-1 rounded-full text-xs ${statusColor(q.status)}`}>{t(`adminDashboard.statuses.${q.status}`)}</span></div><div className="grid grid-cols-3 gap-2 text-center"><div className="p-2 bg-gray-100 dark:bg-gray-800 rounded"><p className="text-lg font-bold">{q.currentNumber}</p><p className="text-xs text-gray-500">{t('adminDashboard.queues.current')}</p></div><div className="p-2 bg-amber-500/10 rounded"><p className="text-lg font-bold text-amber-600">{q.waiting}</p><p className="text-xs text-gray-500">{t('adminDashboard.queues.waiting')}</p></div><div className="p-2 bg-emerald-500/10 rounded"><p className="text-lg font-bold text-emerald-600">{q.serving}</p><p className="text-xs text-gray-500">{t('adminDashboard.queues.serving')}</p></div></div></div>)}</div>{queues.length === 0 && <p className="text-center text-gray-500 py-8">{t('adminDashboard.queues.noActiveQueues')}</p>}</div>}

            {activeTab === "admins" && <div className="space-y-4"><button onClick={() => setShowCreateAdmin(true)} className="btn-primary text-sm flex items-center gap-2"><FaPlus /> {t('adminDashboard.admins.addAdmin')}</button><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">{admins.map(a => <div key={a._id} className="card-enterprise p-4 flex items-center gap-3"><FaUserShield className="text-2xl text-emerald-500" /><div><p className="font-medium">{a.name}</p><p className="text-sm text-gray-500">{a.email}</p></div></div>)}</div></div>}

            {activeTab === "health" && <div className="space-y-4"><div className="grid grid-cols-2 md:grid-cols-4 gap-3">{[{ l: t('adminDashboard.health.database'), v: health.database ? t(`adminDashboard.statuses.${health.database}`) : "N/A", c: health.database === "connected" ? "emerald" : "red" }, { l: t('adminDashboard.health.uptime'), v: health.uptimeFormatted || "N/A" }, { l: t('adminDashboard.health.memory'), v: health.memory?.heapUsed || "N/A" }, { l: t('adminDashboard.health.nodeVersion'), v: health.nodeVersion || "N/A" }].map((s, i) => <div key={i} className="card-enterprise p-4 text-center"><p className={`text-lg font-bold ${s.c ? `text-${s.c}-600` : ""}`}>{s.v}</p><p className="text-xs text-gray-500">{s.l}</p></div>)}</div><div className="card-enterprise p-4"><h3 className="font-semibold mb-2">{t('adminDashboard.health.dbCounts')}</h3><div className="grid grid-cols-3 gap-3">{[{ l: t('adminDashboard.overview.totalUsers'), v: health.counts?.users }, { l: t('adminDashboard.overview.totalBusinesses'), v: health.counts?.businesses }, { l: t('adminDashboard.overview.totalTickets'), v: health.counts?.tickets }].map((s, i) => <div key={i} className="text-center p-3 bg-gray-100 dark:bg-gray-800 rounded"><p className="text-xl font-bold">{s.v || 0}</p><p className="text-xs text-gray-500">{s.l}</p></div>)}</div></div></div>}
          </main>
        </div>

        {editingUser && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white dark:bg-gray-900 rounded-xl p-6 w-full max-w-md"><h2 className="font-bold mb-4">{t('adminDashboard.users.edit')}</h2><div className="space-y-3"><input value={editForm.name} onChange={e => setEditForm(p => ({ ...p, name: e.target.value }))} placeholder={t('adminDashboard.admins.namePlaceholder')} className="input-enterprise" /><input value={editForm.email} onChange={e => setEditForm(p => ({ ...p, email: e.target.value }))} placeholder={t('adminDashboard.admins.emailPlaceholder')} className="input-enterprise" /></div><div className="flex gap-3 mt-4"><button onClick={updateUser} disabled={submitting} className="flex-1 btn-primary">{submitting ? "..." : t('adminDashboard.common.update')}</button><button onClick={() => setEditingUser(null)} className="flex-1 btn-secondary">{t('adminDashboard.common.cancel')}</button></div></div></div>}
        {editingBusiness && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white dark:bg-gray-900 rounded-xl p-6 w-full max-w-md"><h2 className="font-bold mb-4">{t('adminDashboard.modals.editBusiness')}</h2><div className="space-y-3"><input value={businessForm.name} onChange={e => setBusinessForm(p => ({ ...p, name: e.target.value }))} placeholder={t('adminDashboard.admins.namePlaceholder')} className="input-enterprise" /><select value={businessForm.status} onChange={e => setBusinessForm(p => ({ ...p, status: e.target.value }))} className="input-enterprise"><option value="active">{t('common.active')}</option><option value="inactive">{t('common.inactive')}</option></select></div><div className="flex gap-3 mt-4"><button onClick={updateBusiness} disabled={submitting} className="flex-1 btn-primary">{submitting ? "..." : t('adminDashboard.common.update')}</button><button onClick={() => setEditingBusiness(null)} className="flex-1 btn-secondary">{t('adminDashboard.common.cancel')}</button></div></div></div>}
        {viewBusiness && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white dark:bg-gray-900 rounded-xl p-6 w-full max-w-lg max-h-[80vh] overflow-y-auto"><div className="flex justify-between mb-4"><h2 className="font-bold">{viewBusiness.name}</h2><button onClick={() => setViewBusiness(null)}><FaTimes /></button></div><div className="grid grid-cols-2 gap-3 text-sm">{[{ l: t('adminDashboard.users.status'), v: t(`adminDashboard.statuses.${viewBusiness.status}`) }, { l: t('adminDashboard.categories.category'), v: viewBusiness.specialization }, { l: t('adminDashboard.admins.emailPlaceholder').replace(' *', ''), v: viewBusiness.email }, { l: t('contact.form.phone'), v: viewBusiness.mobilePhone }].map((f, i) => <div key={i} className="p-3 bg-gray-100 dark:bg-gray-800 rounded"><p className="text-gray-500 text-xs">{f.l}</p><p>{f.v || "N/A"}</p></div>)}</div>{viewBusiness.service?.length > 0 && <div className="mt-4"><p className="font-medium mb-2">{t('homePage.services')}</p>{viewBusiness.service.map((s, i) => <div key={i} className="flex justify-between p-2 bg-gray-100 dark:bg-gray-800 rounded mb-1 text-sm"><span>{s.name}</span><span className="font-bold">{s.price} EGP</span></div>)}</div>}</div></div>}
        {deleteConfirm && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white dark:bg-gray-900 rounded-xl p-6 w-full max-w-sm text-center"><FaTrash className="text-red-500 text-3xl mx-auto mb-4" /><p className="mb-4">{t('adminDashboard.common.deleteConfirm', { name: deleteConfirm.n })}</p><div className="flex gap-3"><button onClick={() => { if (deleteConfirm.t === "user") deleteUser(deleteConfirm.id); else if (deleteConfirm.t === "business") deleteBusiness(deleteConfirm.id); else deleteReview(deleteConfirm.id); }} disabled={submitting} className="flex-1 btn-danger">{submitting ? "..." : t('adminDashboard.users.delete')}</button><button onClick={() => setDeleteConfirm(null)} className="flex-1 btn-secondary">{t('adminDashboard.common.cancel')}</button></div></div></div>}
        {showCreateAdmin && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white dark:bg-gray-900 rounded-xl p-6 w-full max-w-md"><h2 className="font-bold mb-4">{t('adminDashboard.admins.createTitle')}</h2><div className="space-y-3"><input value={newAdmin.name} onChange={e => setNewAdmin(p => ({ ...p, name: e.target.value }))} placeholder={t('adminDashboard.admins.namePlaceholder')} className="input-enterprise" /><input value={newAdmin.email} onChange={e => setNewAdmin(p => ({ ...p, email: e.target.value }))} placeholder={t('adminDashboard.admins.emailPlaceholder')} className="input-enterprise" /><input type="password" value={newAdmin.password} onChange={e => setNewAdmin(p => ({ ...p, password: e.target.value }))} placeholder={t('adminDashboard.admins.passwordPlaceholder')} className="input-enterprise" /></div><div className="flex gap-3 mt-4"><button onClick={createAdmin} disabled={submitting} className="flex-1 btn-primary">{submitting ? "..." : t('adminDashboard.common.create')}</button><button onClick={() => setShowCreateAdmin(false)} className="flex-1 btn-secondary">{t('adminDashboard.common.cancel')}</button></div></div></div>}
        {showAnnouncement && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white dark:bg-gray-900 rounded-xl p-6 w-full max-w-md"><h2 className="font-bold mb-4 flex items-center gap-2"><FaBullhorn className="text-indigo-500" /> {t('adminDashboard.announcement.title')}</h2><div className="space-y-3"><input value={announcement.title} onChange={e => setAnnouncement(p => ({ ...p, title: e.target.value }))} placeholder={t('adminDashboard.announcement.titlePlaceholder')} className="input-enterprise" /><textarea value={announcement.message} onChange={e => setAnnouncement(p => ({ ...p, message: e.target.value }))} placeholder={t('adminDashboard.announcement.messagePlaceholder')} rows={3} className="input-enterprise" /><select value={announcement.targetAudience} onChange={e => setAnnouncement(p => ({ ...p, targetAudience: e.target.value }))} className="input-enterprise"><option value="all">{t('adminDashboard.announcement.targetAll')}</option><option value="users">{t('adminDashboard.announcement.targetUsers')}</option><option value="owners">{t('adminDashboard.announcement.targetOwners')}</option></select></div><div className="flex gap-3 mt-4"><button onClick={sendAnnouncement} disabled={submitting} className="flex-1 btn-primary">{submitting ? "..." : t('adminDashboard.announcement.send')}</button><button onClick={() => setShowAnnouncement(false)} className="flex-1 btn-secondary">{t('adminDashboard.common.cancel')}</button></div></div></div>}
        {toast && <div className="fixed bottom-4 right-4 z-50"><div className={`px-4 py-3 rounded shadow-xl flex items-center gap-2 ${toast.type === "success" ? "bg-emerald-500" : "bg-red-500"} text-white`}>{toast.type === "success" ? <FaCheckCircle /> : <FaTimesCircle />}{toast.message}</div></div>}
      </div>
    </ProtectedRoute>
  );
}



